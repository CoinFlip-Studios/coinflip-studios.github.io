<!DOCTYPE html>
<html>

<head>
  <title>AR.js Basketball</title>
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
  <script
    src="https://unpkg.com/aframe-aabb-collider-component@3.2.2/dist/aframe-aabb-collider-component.min.js"></script>

  <script>
    //not sure if this is necessary at this point anymore....
    //will leave in for the moment and cleanup at a later time
    AFRAME.registerComponent('wait-for-assets',{
      init: function(){
        const el = this.el;
        const sceneEl = el.sceneEl;

        if(sceneEl.hadLoaded){
          this.applyMaterial();
        }else{
          sceneEl.addEventListener('loaded', () =>{
            this.applyMaterial();
          });
        }
      },

      applyMaterial: function(){
        setTimeout(() => {
          this.el.setAttribute('material', 'src:#ball_texture');
        }, 1000);
      }
    });


    AFRAME.registerComponent('flickable', {
      init: function () {
        let el = this.el;
        let start = null;

        window.addEventListener('touchstart', (e) => {
          if (e.touches.length === 1) {
            start = e.touches[0];
          }
        });

        window.addEventListener('touchend', (e) => {
          if (!start) return;

          let end = e.changedTouches[0];
          let dx = end.clientX - start.clientX;
          let dy = end.clientY - start.clientY;

          let force = dy * 0.05;
          console.log("DY  " + dy);

          // Only trigger on vertical flick
          if (Math.abs(dy) > 30 && Math.abs(dy) > Math.abs(dx)) {
            const camera = document.querySelector('[camera]').object3D;
            const forward = new THREE.Vector3();
            camera.getWorldDirection(forward);
            forward.y -= 0.3;
            forward.multiplyScalar(force); // Invert to move away from camera

            el.setAttribute('velocity', {
              x: forward.x,
              y: forward.y,
              z: forward.z
            });
              
            el.setAttribute('animation', {
              property: 'rotation',
              to: '360 360 180',
              loop: true,
              dur: 2000,
              easing: 'linear'
            });

            // Ensure dynamic-body is active
            el.setAttribute('dynamic-body', 'mass: 1');
          }
          start = null;
        });
      },

      tick: function () {
        const startPos = new THREE.Vector3(0, -0.3, -1.5);

        let objPos = new THREE.Vector3();
        objPos = this.el.getAttribute('position');
        console.log(objPos.x);

        //pseudo gravitational decay for ball obj
        if (objPos.z != -1.5) {
          if (objPos.y >= 1 && objPos.y <= 0.9) {
            let travel = new THREE.Vector3();
            travel = this.el.getAttribute('velocity');
            travel.y -= 0.05;
            this.el.setAttribute('velocity', {
              x: travel.x,
              y: travel.y,
              z: travel.z
            });
          }
          else {
            let travel = new THREE.Vector3();
            travel = this.el.getAttribute('velocity');
            travel.y -= 0.08;
            this.el.setAttribute('velocity', {
              x: travel.x,
              y: travel.y,
              z: travel.z
            });
          }
        }

        //testing if ball has gone too far, return to original pos, reset animation
        if (objPos.z <= -15) {
          console.log("Air ball!");
          this.el.setAttribute('position', startPos);
          this.el.setAttribute('velocity', {
            x: 0,
            y: 0,
            z: 0
          });
          //this.el.setAttribute('animation', 'enabled', false);
           this.el.setAttribute('animation', {
              property: 'rotation',
              to: '0 0 0',
              loop: false,
              dur: 0,
              easing: 'linear'
            });
        }

      }
    });
  </script>
  <script>
    AFRAME.registerComponent('hit', {
      init: function () {
        this.el.addEventListener('hitstart', (e) => {
          console.log(e)
        })
        this.el.addEventListener('hit', (e) => {
          console.log(e)
        })
        this.el.addEventListener('hitend', (e) => {
          console.log('hitend')
          console.log(e)
          setScore();
        })
      }
    });

    function setScore() {
      console.log("Called!");
      const scoreTarget = document.getElementById("score");
      var content = scoreTarget.textContent;

      var currentScore = content.charAt(content.length - 1);
      var newScore = parseInt(currentScore) + 1;
      scoreTarget.innerHTML = "Score: " + newScore;
    }

  </script>

</head>

<body style="margin: 0; overflow: hidden;">
  <a-scene embedded arjs physics="gravity: 0 -9.8 0; restitution: 0.3">

    <a-assets>
      <a-asset-item id="hoop" src="./assets/basketball_hoop/scene.gltf"></a-asset-item>
    </a-assets>
    <a-assets>
      <img id="ball_texture"
        src="./assets/textures/balldimpled.png"></img>
    </a-assets>

    <!-- Marker -->
    <a-marker preset='custom' type='pattern'
      url='/coinflip-studios.github.io/webAR/assets/markers/pattern-ic-logo.patt'>
      <!-- Backboard -->
        <a-box 
          position="0 -2 -.3" 
          width="3" 
          height="0.1" 
          depth="2"
          material="color: white; transparent: true; opacity: 0.9"
          static-body="shape: box">
        </a-box>
      <a-entity gltf-model="#hoop" position="0 0 .8" rotation="0 90 270" scale="1.5 1.5 1.5"></a-entity>
      <a-box id="hoop_placement" height=".75" width=".75" depth="0.01" material="color: blue" position="0 0 0.25"
        visible="true" hit aabb-collider="objects: a-sphere">
      </a-box>
    </a-marker>

    <a-sphere data-aabb-collider-dynamic sphere-collider='objects: a-sphere' id="ball"
      geometry="primitive: sphere; radius: 0.1" material="src: #ball_texture" position="0 -0.3 -1.5" dynamic-body
      flickable wait-for-assets>
    </a-sphere>

    <!-- Camera -->
    <a-entity camera></a-entity>
  </a-scene>

  <!-- UI Button -->
  <div style="position: fixed; top: 20px; left: 20px; z-index: 9999;">
    <button>Start</button>
  </div>
  <div style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
    <p id="score">Score: 0</p>
  </div>
</body>

</html>
