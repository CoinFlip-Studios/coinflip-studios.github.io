<!DOCTYPE html>
<html>

<head>
  <title>AR.js Hiro Marker Example</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
  <script>
  AFRAME.registerComponent('flickable', {
    init: function () {
      let el = this.el;
      let start = null;

      window.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
          start = e.touches[0];
        }
      });

      window.addEventListener('touchend', (e) => {
        if (!start) return;

        let end = e.changedTouches[0];
        let dx = end.clientX - start.clientX;
        let dy = end.clientY - start.clientY;

        // Only trigger on vertical flick
        if (Math.abs(dy) > 30 && Math.abs(dy) > Math.abs(dx)) {
          const camera = document.querySelector('[camera]').object3D;
          const forward = new THREE.Vector3();
          camera.getWorldDirection(forward);
          forward.multiplyScalar(-2); // Invert to move away from camera

          el.setAttribute('velocity', {
            x: forward.x,
            y: forward.y,
            z: forward.z
          });

          // Ensure dynamic-body is active
          el.setAttribute('dynamic-body', 'mass: 1');
        }
        start = null;
      });
    }
  });
  </script>
  <script>
    function placeHoop(){
      const marker = document.querySelector('#marker');
      const placement = document.querySelector('#hoop_placement');
      const hoop = document.querySelector('#hoop');

      // Wait for marker to be visible/tracked
      if (!marker.object3D.visible) {
        alert("Marker not visible yet!");
        return;
      }

      // Get world position and quaternion (rotation)
      const worldPos = new THREE.Vector3();
      const worldQuat = new THREE.Quaternion();
      const worldScale = new THREE.Vector3();

      placement.object3D.updateMatrixWorld(true);
      placement.object3D.matrixWorld.decompose(worldPos, worldQuat, worldScale);

      // Set hoop to exact world pose
      hoop.object3D.position.copy(worldPos);
      hoop.object3D.quaternion.copy(worldQuat);
      hoop.setAttribute("visible", true);
    }
  </script>
</head>

<body style="margin: 0; overflow: hidden;">
   <div style="position: fixed; top: 20px; left: 20px; z-index: 9999;">
    <button onclick="placeHoop()">Start</button>
  </div>
  <a-scene embedded arjs obb-collider="showColliders: true">
    <!-- Assets -->
    <a-assets>
      <a-asset-item id="basketball_hoop" src="assets/basketball_hoop/scene.gltf"></a-asset-item>
    </a-assets>

    <!-- Marker with model -->
    <a-marker preset="hiro">
      <a-entity id="hoop_placement"
        geometry="primitive: box; width: 1" 
        material="color: blue"
        position="0 -1 0"
        visible="true">

      </a-entity>
     <!-- <a-entity gltf-model="#basketball_hoop" scale="0.001 0.001 0.001" position="0 0 0" rotation="270 180 180" obb-collider static-body>
      </a-entity>-->

      <!--
        #TODO
        lower torus
        physics
          ball arc
          collisions
        counter
        test with hoop marker image
      -->
    

    </a-marker>

      <a-entity id="hoop"
      geometry="primitive: torus; arc: 360; radius: 1; radiusTubular: 0.02"
      material="color: green"
      position="0 0 0"
      visible="false"
      static-body>
      </a-entity>

    <a-entity id="ball" 
          geometry="primitive: sphere; radius: 0.1" 
          material="color: orange" 
          position="0 -0.3 -1.5"
          dynamic-body 
          flickable obb-collider
          visible="false">
    </a-entity>

    <!-- Camera -->
    <a-entity camera></a-entity>
  </a-scene>
  
</body>

</html>