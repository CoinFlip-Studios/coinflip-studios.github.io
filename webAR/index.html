<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>AR Basketball</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{overflow:hidden;touch-action:none;-webkit-user-select:none;user-select:none;font-family:sans-serif}
    #score{position:fixed;top:20px;left:20px;z-index:9999;color:#fff;font-size:24px;text-shadow:0 2px 4px rgba(0,0,0,0.5)}
    #swipe-zone{position:fixed;bottom:0;left:0;right:0;height:60%;z-index:9998;pointer-events:all}
    .swipe-trail{position:fixed;z-index:9997;pointer-events:none;width:14px;height:14px;border-radius:50%;background:radial-gradient(circle,rgba(255,100,0,0.7),transparent);opacity:0;animation:trailFade .4s ease forwards}
    @keyframes trailFade{0%{opacity:.8;transform:scale(1)}100%{opacity:0;transform:scale(.2)}}
  </style>
</head>
<body>

<div id="score">Score: 0</div>
<div id="swipe-zone"></div>

<a-scene embedded arjs="sourceType:webcam;debugUIEnabled:false;detectionMode:mono_and_matrix;matrixCodeType:3x3;" renderer="logarithmicDepthBuffer:true;antialias:true;alpha:true;" vr-mode-ui="enabled:false">
  <a-entity camera></a-entity>
  <a-marker id="hiro-marker" preset="hiro" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="2"></a-marker>
  <a-entity id="hoop-container" visible="false">
    <a-box position="0 2.4 0" width="1.5" height="1.1" depth="0.08" color="#FFFFFF" material="opacity:0.95"></a-box>
    <a-box position="0 2.4 0.042" width="1.54" height="1.14" depth="0.005" color="#222"></a-box>
    <a-box position="0 2.2 0.046" width="0.6" height="0.45" depth="0.003" color="#FF5722" material="wireframe:true"></a-box>
    <a-box position="0 2.2 0.045" width="0.58" height="0.43" depth="0.004" color="#FF5722" material="opacity:0.15;transparent:true"></a-box>
    <a-torus id="rim" position="0 1.85 0.5" rotation="90 0 0" radius="0.32" radius-tubular="0.028" segments-radial="24" segments-tubular="48" color="#FF3D00" material="metalness:0.85;roughness:0.2"></a-torus>
    <a-cylinder position="-0.16 1.85 0.25" rotation="90 0 0" radius="0.02" height="0.5" color="#777" material="metalness:0.6"></a-cylinder>
    <a-cylinder position="0.16 1.85 0.25" rotation="90 0 0" radius="0.02" height="0.5" color="#777" material="metalness:0.6"></a-cylinder>
    <a-torus class="net-ring" id="net0" position="0 1.85 0.55" rotation="90 0 0" radius="0.29" radius-tubular="0.006" color="#FFFFFF" material="opacity:0.6;transparent:true"></a-torus>
    <a-torus class="net-ring" id="net1" position="0 1.85 0.63" rotation="90 0 0" radius="0.26" radius-tubular="0.006" color="#FFFFFF" material="opacity:0.5;transparent:true"></a-torus>
    <a-torus class="net-ring" id="net2" position="0 1.85 0.71" rotation="90 0 0" radius="0.23" radius-tubular="0.006" color="#FFFFFF" material="opacity:0.45;transparent:true"></a-torus>
    <a-torus class="net-ring" id="net3" position="0 1.85 0.79" rotation="90 0 0" radius="0.20" radius-tubular="0.006" color="#FFFFFF" material="opacity:0.4;transparent:true"></a-torus>
    <a-torus class="net-ring" id="net4" position="0 1.85 0.87" rotation="90 0 0" radius="0.17" radius-tubular="0.005" color="#FFFFFF" material="opacity:0.35;transparent:true"></a-torus>
    <a-torus class="net-ring" id="net5" position="0 1.85 0.95" rotation="90 0 0" radius="0.13" radius-tubular="0.005" color="#FFFFFF" material="opacity:0.25;transparent:true"></a-torus>
    <a-cylinder position="0 1.15 -0.05" radius="0.065" height="2.3" color="#555" material="metalness:0.7;roughness:0.35"></a-cylinder>
    <a-box position="0 0.03 -0.05" width="0.9" height="0.06" depth="0.9" color="#333" material="metalness:0.5"></a-box>
    <a-plane position="0 0.005 1.8" rotation="-90 0 0" width="4" height="5" color="#C67B30" material="opacity:0.35;transparent:true"></a-plane>
    <a-plane position="0 0.015 2.2" rotation="-90 0 0" width="2.4" height="0.04" color="#FFF" material="opacity:0.6;transparent:true"></a-plane>
    <a-torus position="0 0.015 0.5" rotation="90 0 0" radius="2.0" radius-tubular="0.02" segments-radial="8" segments-tubular="40" color="#FFF" material="opacity:0.3;transparent:true" theta-length="180"></a-torus>
  </a-entity>
</a-scene>

<script>
document.querySelector('a-scene').addEventListener('loaded', function() {
  const GRAVITY=-9.8,BALL_R=0.16,FRICTION=0.25;
  const NET_RINGS=[{id:'net0',oy:1.85,oz:0.55,or:0.29},{id:'net1',oy:1.85,oz:0.63,or:0.26},{id:'net2',oy:1.85,oz:0.71,or:0.23},{id:'net3',oy:1.85,oz:0.79,or:0.20},{id:'net4',oy:1.85,oz:0.87,or:0.17},{id:'net5',oy:1.85,oz:0.95,or:0.13}];
  const netState=NET_RINGS.map(r=>({el:null,...r,offsetX:0,offsetZ:0,velX:0,velZ:0}));
  const C={rim:{cx:0,cy:1.85,cz:0.5,majorR:0.32,tubeR:0.028,bounce:0.55},backboard:{cx:0,cy:2.4,cz:0,hw:0.75,hh:0.55,hd:0.04,bounce:0.45},pole:{cx:0,cy:1.15,cz:-0.05,r:0.065,halfH:1.15,bounce:0.4},base:{cx:0,cy:0.03,cz:-0.05,hw:0.45,hh:0.03,hd:0.45,bounce:0.4},floor:{y:0.0,bounce:0.65}};

  let score=0,markerVisible=false,hoopInitialized=false,balls=[],swipeStart=null;
  let hoopWorldMatrix=new THREE.Matrix4(),hoopWorldMatrixInverse=new THREE.Matrix4();

  const scoreEl=document.getElementById('score'),swipeZone=document.getElementById('swipe-zone'),sceneEl=document.querySelector('a-scene'),markerEl=document.getElementById('hiro-marker'),hoopContainer=document.getElementById('hoop-container');

  netState.forEach(ns=>{ns.el=document.getElementById(ns.id);});

  markerEl.addEventListener('markerFound',()=>{markerVisible=true;hoopInitialized=true;hoopContainer.setAttribute('visible','true');});
  markerEl.addEventListener('markerLost',()=>{markerVisible=false;});

  swipeZone.addEventListener('touchstart',tsS,{passive:false});
  swipeZone.addEventListener('touchmove',tsM,{passive:false});
  swipeZone.addEventListener('touchend',tsE,{passive:false});
  swipeZone.addEventListener('mousedown',e=>{tsS({preventDefault(){},touches:[{clientX:e.clientX,clientY:e.clientY}]});});
  window.addEventListener('mousemove',e=>{if(swipeStart)tsM({preventDefault(){},touches:[{clientX:e.clientX,clientY:e.clientY}]});});
  window.addEventListener('mouseup',e=>{if(swipeStart)tsE({preventDefault(){},changedTouches:[{clientX:e.clientX,clientY:e.clientY}]});});

  function tsS(e){e.preventDefault();if(!hoopInitialized)return;const t=e.touches[0];swipeStart={x:t.clientX,y:t.clientY,time:Date.now()};}
  function tsM(e){e.preventDefault();if(!swipeStart)return;const t=e.touches[0];const tr=document.createElement('div');tr.className='swipe-trail';tr.style.left=(t.clientX-7)+'px';tr.style.top=(t.clientY-7)+'px';document.body.appendChild(tr);setTimeout(()=>tr.remove(),400);}
  function tsE(e){e.preventDefault();if(!swipeStart)return;const t=e.changedTouches[0];const dx=t.clientX-swipeStart.x,dy=t.clientY-swipeStart.y,dt=(Date.now()-swipeStart.time)/1000;swipeStart=null;if(dy>-30)return;const dist=Math.sqrt(dx*dx+dy*dy),speed=dist/Math.max(dt,0.05),hBias=dx/window.innerWidth,power=Math.min(Math.max(speed/1500,0.3),1.0);shoot(power,hBias);}

  function shoot(power,hBias){
    if(!hoopInitialized)return;
    const ball=document.createElement('a-sphere');
    ball.setAttribute('radius',String(BALL_R));
    ball.setAttribute('color','#FF6D00');
    ball.setAttribute('material','roughness:0.55;metalness:0.1');
    const rimLocal=new THREE.Vector3(0,1.85,0.5),rimW=rimLocal.clone().applyMatrix4(hoopWorldMatrix);
    const cam=document.querySelector('[camera]').object3D,cp=new THREE.Vector3(),cd=new THREE.Vector3();
    cam.getWorldPosition(cp);cam.getWorldDirection(cd);
    const sp=cp.clone().add(cd.clone().multiplyScalar(0.4)).add(new THREE.Vector3(0,-0.3,0));
    ball.setAttribute('position',`${sp.x} ${sp.y} ${sp.z}`);
    sceneEl.appendChild(ball);
    const tp=rimW.clone(),cr=new THREE.Vector3();
    cr.crossVectors(cd,new THREE.Vector3(0,1,0)).normalize();
    tp.add(cr.clone().multiplyScalar(hBias*1.2));
    const acc=0.7+power*0.3;
    tp.add(new THREE.Vector3((Math.random()-.5)*(1-acc)*.8,(Math.random()-.5)*(1-acc)*.4,(Math.random()-.5)*(1-acc)*.8));
    const d=tp.clone().sub(sp),hDist=Math.sqrt(d.x*d.x+d.z*d.z),spd=3.5+power*5,ft=hDist/spd||0.8;
    const b={el:ball,pos:sp.clone(),vel:new THREE.Vector3(d.x/ft,(d.y-0.5*GRAVITY*ft*ft)/ft,d.z/ft),time:0,settled:false,scored:false,bounces:0,cooldowns:{},passedNetRings:new Set(),inNet:false};
    balls.push(b);
    setTimeout(()=>{if(ball.parentNode)ball.parentNode.removeChild(ball);const i=balls.indexOf(b);if(i>-1)balls.splice(i,1);},8000);
    if(navigator.vibrate)navigator.vibrate(30);
  }

  function w2l(v){return v.clone().applyMatrix4(hoopWorldMatrixInverse);}
  function l2w(v){return v.clone().applyMatrix4(hoopWorldMatrix);}
  function velW2L(v){return v.clone().applyMatrix3(new THREE.Matrix3().setFromMatrix4(hoopWorldMatrixInverse));}
  function velL2W(v){return v.clone().applyMatrix3(new THREE.Matrix3().setFromMatrix4(hoopWorldMatrix));}

  function reflect(vel,n,rest){const vn=vel.dot(n);if(vn>=0)return false;const vnV=n.clone().multiplyScalar(vn),vtV=vel.clone().sub(vnV);vel.copy(vtV.multiplyScalar(1-FRICTION).add(vnV.multiplyScalar(-rest)));return true;}

  const RIM_SAMPLES=16;
  function hitRim(p,v,rim){
    const{cx,cy,cz,majorR,tubeR,bounce}=rim;
    let closestDist=Infinity,closestNormal=null,closestPen=0;
    for(let i=0;i<RIM_SAMPLES;i++){const angle=(i/RIM_SAMPLES)*Math.PI*2,ringX=cx+Math.cos(angle)*majorR,ringZ=cz+Math.sin(angle)*majorR,dx=p.x-ringX,dy=p.y-cy,dz=p.z-ringZ,dist=Math.sqrt(dx*dx+dy*dy+dz*dz),minDist=BALL_R+tubeR;if(dist<minDist&&dist>0.001&&dist<closestDist){closestDist=dist;closestNormal=new THREE.Vector3(dx/dist,dy/dist,dz/dist);closestPen=minDist-dist;}}
    const dx0=p.x-cx,dz0=p.z-cz,dXZ=Math.sqrt(dx0*dx0+dz0*dz0);
    if(dXZ>0.001){const rx=cx+(dx0/dXZ)*majorR,rz=cz+(dz0/dXZ)*majorR,tdx=p.x-rx,tdy=p.y-cy,tdz=p.z-rz,td=Math.sqrt(tdx*tdx+tdy*tdy+tdz*tdz),minD=BALL_R+tubeR;if(td<minD&&td>0.001&&td<closestDist){closestDist=td;closestNormal=new THREE.Vector3(tdx/td,tdy/td,tdz/td);closestPen=minD-td;}}
    if(closestNormal){p.x+=closestNormal.x*closestPen;p.y+=closestNormal.y*closestPen;p.z+=closestNormal.z*closestPen;reflect(v,closestNormal,bounce);return true;}
    return false;
  }

  function hitBox(p,v,b){const clx=Math.max(b.cx-b.hw,Math.min(p.x,b.cx+b.hw)),cly=Math.max(b.cy-b.hh,Math.min(p.y,b.cy+b.hh)),clz=Math.max(b.cz-b.hd,Math.min(p.z,b.cz+b.hd)),dx=p.x-clx,dy=p.y-cly,dz=p.z-clz,dist=Math.sqrt(dx*dx+dy*dy+dz*dz);if(dist<BALL_R&&dist>0.001){const n=new THREE.Vector3(dx,dy,dz).normalize(),pen=BALL_R-dist;p.x+=n.x*pen;p.y+=n.y*pen;p.z+=n.z*pen;reflect(v,n,b.bounce);return true;}return false;}

  function hitCyl(p,v,c){const clY=Math.max(c.cy-c.halfH,Math.min(p.y,c.cy+c.halfH)),dx=p.x-c.cx,dz=p.z-c.cz,dXZ=Math.sqrt(dx*dx+dz*dz),minD=BALL_R+c.r;if(dXZ<minD&&Math.abs(p.y-clY)<BALL_R){if(dXZ<0.001)return false;if(p.y>c.cy+c.halfH||p.y<c.cy-c.halfH){const n=new THREE.Vector3(0,p.y>c.cy?1:-1,0);p.y+=n.y*(BALL_R-Math.abs(p.y-clY));reflect(v,n,c.bounce);return true;}const n=new THREE.Vector3(dx/dXZ,0,dz/dXZ);p.x+=n.x*(minD-dXZ);p.z+=n.z*(minD-dXZ);reflect(v,n,c.bounce);return true;}return false;}

  function hitFloor(p,v,f){if(p.y-BALL_R<f.y){p.y=f.y+BALL_R;reflect(v,new THREE.Vector3(0,1,0),f.bounce);return true;}return false;}

  const NET_SPRING=80,NET_DAMP=8,NET_PUSH=1.2;
  function updateNet(dt){for(const ns of netState){if(!ns.el)continue;const ax=-NET_SPRING*ns.offsetX-NET_DAMP*ns.velX,az=-NET_SPRING*ns.offsetZ-NET_DAMP*ns.velZ;ns.velX+=ax*dt;ns.velZ+=az*dt;ns.offsetX+=ns.velX*dt;ns.offsetZ+=ns.velZ*dt;ns.offsetX=Math.max(-0.15,Math.min(0.15,ns.offsetX));ns.offsetZ=Math.max(-0.15,Math.min(0.15,ns.offsetZ));ns.el.setAttribute('position',`${ns.offsetX.toFixed(4)} ${ns.oy.toFixed(4)} ${(ns.oz+ns.offsetZ).toFixed(4)}`);}}

  function pushNetRing(idx,lp,lv){const ns=netState[idx];if(!ns)return;ns.velX+=(lp.x*NET_PUSH+lv.x*0.05)*15;ns.velZ+=((lp.z-ns.oz)*NET_PUSH+lv.z*0.05)*15;}

  function checkNetPassThrough(b,lp,lv){
    for(let i=0;i<NET_RINGS.length;i++){
      if(b.passedNetRings.has(i))continue;
      const ring=NET_RINGS[i],dxR=lp.x-C.rim.cx,dzR=lp.z-ring.oz,distFromCenter=Math.sqrt(dxR*dxR+dzR*dzR);
      if(distFromCenter<ring.or+BALL_R*0.5&&Math.abs(lp.y-ring.oy)<BALL_R*1.5&&lv.y<0){
        b.passedNetRings.add(i);
        pushNetRing(i,lp,lv);
        lv.x*=0.92;lv.z*=0.92;lv.y*=0.95;
        b.inNet=true;
      }
    }
    if(!b.scored&&b.passedNetRings.size>=3&&lv.y<0){
      b.scored=true;
      score++;
      scoreEl.textContent='Score: '+score;
      if(navigator.vibrate)navigator.vibrate([50,30,80]);
    }
  }

  let lt=performance.now();
  function loop(now){
    const dt=Math.min((now-lt)/1000,0.05);
    lt=now;
    if(markerVisible){const markerObj=markerEl.object3D;markerObj.updateMatrixWorld(true);hoopWorldMatrix.copy(markerObj.matrixWorld);hoopWorldMatrixInverse.copy(hoopWorldMatrix).invert();hoopContainer.object3D.position.setFromMatrixPosition(hoopWorldMatrix);hoopContainer.object3D.quaternion.setFromRotationMatrix(hoopWorldMatrix);hoopContainer.object3D.scale.setFromMatrixScale(hoopWorldMatrix);}
    updateNet(dt);
    if(!hoopInitialized){requestAnimationFrame(loop);return;}
    for(const b of balls){
      if(b.settled)continue;
      b.vel.y+=GRAVITY*dt;b.pos.x+=b.vel.x*dt;b.pos.y+=b.vel.y*dt;b.pos.z+=b.vel.z*dt;
      const lp=w2l(b.pos),lv=velW2L(b.vel),ms=Date.now();
      if(!b.cooldowns.rim||ms-b.cooldowns.rim>80){if(hitRim(lp,lv,C.rim)){b.bounces++;b.cooldowns.rim=ms;if(navigator.vibrate)navigator.vibrate(15);}}
      if(!b.cooldowns.bb||ms-b.cooldowns.bb>120){if(hitBox(lp,lv,C.backboard)){b.bounces++;b.cooldowns.bb=ms;if(navigator.vibrate)navigator.vibrate(15);}}
      if(!b.cooldowns.pole||ms-b.cooldowns.pole>120){if(hitCyl(lp,lv,C.pole)){b.bounces++;b.cooldowns.pole=ms;if(navigator.vibrate)navigator.vibrate(10);}}
      if(!b.cooldowns.base||ms-b.cooldowns.base>120){if(hitBox(lp,lv,C.base)){b.bounces++;b.cooldowns.base=ms;if(navigator.vibrate)navigator.vibrate(10);}}
      if(!b.cooldowns.floor||ms-b.cooldowns.floor>80){if(hitFloor(lp,lv,C.floor)){b.bounces++;b.cooldowns.floor=ms;if(navigator.vibrate)navigator.vibrate(20);}}
      checkNetPassThrough(b,lp,lv);
      b.pos.copy(l2w(lp));b.vel.copy(velL2W(lv));
      b.el.setAttribute('position',`${b.pos.x} ${b.pos.y} ${b.pos.z}`);
      b.time+=dt;
      const spin=b.inNet?50:400;
      b.el.setAttribute('rotation',`${b.time*spin} ${b.time*spin*0.3} 0`);
      const sp=b.vel.length(),flp=w2l(b.pos);
      if(sp<0.2&&flp.y<0.25&&b.bounces>2)b.settled=true;
      if(b.pos.y<-5)b.settled=true;
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
});
</script>
</body>
</html>
